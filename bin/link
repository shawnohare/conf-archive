#!/usr/bin/env bash

set -e

CONF="${CONF:-${HOME}/conf}"

# Wrapper for GNU stow
link_dir() {

  if [ -z "${1}" ] || [ -z "${2}" ]; then
    >&2 echo "Error: No source or target dir passed."
    return 1
  fi

  local src="${1}"
  local tar="${2}"

  echo "Linking ${src} to ${tar}"

  # Hard copy the dir tree to the target.
  cd "${CONF}/${src}"
  while read -r path; do
    local dest="${tar}/${path}"
    mkdir -p "${dest}"
  done < <(find . -type d)
  stow -R --target="${tar}" --dir="${CONF}" "${src}"
}

# Link config files.
main () {
  local dirs=(
      alacritty
      # bash
      emacs
      fish
      git
      ipython
      nix
      nvim
      profile
      screen
      spacemacs
      tmux
      vim
      zsh
  )

  # Link the specified folder if provided, else everything.
  if [ ! -z "${1+x}" ]; then
    dirs=("$1")
  fi

  for dir in "${dirs[@]}"; do
    link_dir "${dir}" "${HOME}"
  done

}

main "$@"
