#!/usr/bin/env bash

set -e


CONF_HOME="${CONF_HOME:-${HOME}/conf}"

# Link configuration files contained inside the configuration repository.
conf::link () {

  if [ -z "$1" ] || [ -z "$2" ]; then
	  echo "Source and target dirs not specified. Exiting."
	  exit 1
  fi

  src_dir="$1"
  tar_dir="$2"


  printf "Linking ${src_dir} -> ${tar_dir}\n"

  cd "${CONF_HOME}/${src_dir}"

  # Hard copy the dir tree to the target. This is done primarily so that
  # data files are not stored in the configuration repo.
  while read -r path; do
    mkdir -p "${tar_dir}/${path}"
  done < <(find . -type d)

  # Symlink files to the target.
  while read -r path; do
    # Ignore the initial ./ appearing in the results of find output.
    local path="${path:2}"
    local src="${CONF_HOME}/${src_dir}/${path}"
    local tar="${tar_dir}/${path}"

    # Backup existing files.
    if [ -f "${tar}" ] && [ ! -L "${tar}" ]; then
      if [ ! -f "${tar}.bak" ]; then
        printf "  \e[1m\e[33m Copying \e[0m${tar}\n"
        mv "${tar}" "${tar}.bak"
      else
        printf "\e[1m\e[31mWARNING: \e[0m Non link ${tar} and backup exists. Skipping.\n"
        continue
      fi
    fi

    if [ ! -L "${tar}" ]; then
      printf "  \e[1m\e[32mLinking \e[0m${path}\n"
      ln -s "${src}" "${tar}"
    fi


  done < <(find . -type f)
}

conf::link "$@"

