#!/usr/bin/env bash

set -e


CONF="${CONF:-${HOME}/conf}"

# Link configuration files stored inside a specified directory.
conflink () {

  if [ -z "${1}" ]; then
    >&2 echo "Error: No source or target dir passed."
    return 1
  fi

  local src_dir="${1}"
  local tar_dir="${2}"
  if [ -z "${tar_dir}" ]; then tar_dir="${HOME}"; fi

  echo "Linking ${src_dir}"

  cd "${CONF}/${src_dir}"

  # Hard copy the dir tree to the target. This is done primarily so that
  # data files are not stored in the configuration repo.
  while read -r path; do
    mkdir -p "${tar_dir}/${path}"
  done < <(find . -type d)

  # Symlink files to the target.
  while read -r path; do
    # Ignore the initial ./ appearing in the results of find output.
    local path="${path:2}"
    local src="${CONF}/${src_dir}/${path}"
    local tar="${tar_dir}/${path}"

    if [ -f "${tar}" ] && [ ! -L "${tar}" ]; then
      echo "WARNING: ${tar} exists and is not a symbolic link. Skipping."
      exit 1
    fi

    if [ ! -L "${tar}" ]; then
      echo "Linking ${src} to ${tar}"
      ln -s "${src}" "${tar}"
    fi


  done < <(find . -type f)

  # stow -v -R --target="${tar}" --dir="${CONF}" "${src}"
}

# Link the following directories.
conflink home


