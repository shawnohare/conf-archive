#!/usr/bin/env bash

set -e

CONF="${CONF:-${HOME}/conf}"

# Wrapper for GNU stow
link_dir() {

  if [ -z "${1}" ] || [ -z "${2}" ]; then
    >&2 echo "Error: No source or target dir passed."
    return 1
  fi

  local src_dir="${1}"
  local tar_dir="${2}"

  cd "${CONF}/${src_dir}"

  # Hard copy the dir tree to the target. This is done primarily so that
  # data files are not stored in the configuration repo. 
  while read -r path; do
    mkdir -p "${tar_dir}/${path}"
  done < <(find . -type d)

  # Symlink files to the target.
  while read -r path; do
    # Ignore the initial ./ appearing in the results of find output.
    local path="${path:2}"
    local src="${CONF}/${src_dir}/${path}"
    local tar="${tar_dir}/${path}"

    if [ -f "${tar}" ] && [ ! -L "${tar}" ]; then
      echo "${tar} exists and is not a symbolic link. Exiting."
      exit 1
    fi

    if [ ! -L "${tar}" ]; then
      echo "Linking ${src} to ${tar}"
      ln -s "${src}" "${tar}"
    else
      echo "Link from ${src} to ${tar} already exists. Skipping."
    fi


  done < <(find . -type f)

  # stow -v -R --target="${tar}" --dir="${CONF}" "${src}"
}

# Link config files.
main () {
  local dirs=(
      alacritty
      # bash
      emacs
      fish
      git
      ipython
      nix
      nvim
      profile
      screen
      spacemacs
      stack
      tmux
      vim
      zsh
  )

  # Link the specified folder if provided, else everything.
  if [ ! -z "${1+x}" ]; then
    dirs=("$1")
  fi

  for dir in "${dirs[@]}"; do
    link_dir "${dir}" "${HOME}"
  done

}

main "$@"
