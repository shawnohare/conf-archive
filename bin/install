#!/usr/bin/env bash

set -e

dir="${CONF:-${HOME}/conf}"
readonly branch="${CONF_BRANCH:-master}"
readonly repo="https://github.com/shawnohare/conf.git"

if [ ! -d "${dir}" ]; then
  echo "Cloning ${repo}"
  git clone -b "${branch} "--recursive "${repo}" "${dir}"
fi

if [ ! -d "${dir}" ]; then
  >&2 echo "Error: Could not clone config repo."
fi

cd ""${dir}""
git checkout "${branch}"

source "${dir}/profile/.profile"

echo "Making necessary dirs."
mkdir -p "${XDG_CONFIG_HOME}"
mkdir -p "${XDG_DATA_HOME}"
mkdir -p "${XDG_CACHE_HOME}"
mkdir -p "${XDG_STATE_HOME}"
mkdir -p "${XDG_BIN_HOME}"
mkdir -p "${XDG_BIN_HOME}/stow"
mkdir -p "${XDG_LIB_HOME}"
mkdir -p "${XDG_TMP_HOME}"
mkdir -p "${XDG_OPT_HOME}"
mkdir -p "${XDG_VAR_HOME}"
mkdir -p "${HOME}/src"

# Install basic utilities with nix.
"${dir}/bin/init/nix"

# Link config files.
"${dir}/bin/link"

# Run specific init / install scripts.
for bin in zsh nvim golang; do
  echo "Running ${bin}"
  "${dir}/bin/init/${bin}"
done

echo "Finished installing.  Please restart the shell."

