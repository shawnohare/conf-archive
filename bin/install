#! /usr/bin/env bash

# Init basic profile.
CONF="${CONF_HOME:-${HOME}/conf}"

readonly branch="${CONF_HOME_BRANCH:-master}"
readonly repo="https://github.com/shawnohare/conf.git"

if [ ! -d "${CONF_HOME}" ]; then
  echo "Cloning ${repo}"
  git clone -b "${branch} "--recursive "${repo}" "${CONF_HOME}"
fi

if [ ! -d "${CONF_HOME}" ]; then
  >&2 echo "Error: Could not clone config repo."
  exit 1
fi

cd "${CONF_HOME}" || exit 1
git checkout "${branch}"

source src/.env
source src/.profile

mkdir -p "${USER_BIN_HOME}"
mkdir -p "${USER_CONFIG_HOME}"
mkdir -p "${USER_CACHE_HOME}"
mkdir -p "${USER_DATA_HOME}"
mkdir -p "${USER_SRC_HOME}"
mkdir -p "${USER_TMP_HOME}"
mkdir -p "${USER_VAR_HOME}"

"${CONF_HOME}/bin/link"

# Install toolchains and packages related to those toolchains.
# NOTE: It's possible that a multi-user nix install might fail here.
for tool in python nix go rust zsh; do
  dir="${CONF_HOME}/bin/${tool}"
  for x in install setup pkgs; do
    cmd="${CONF_HOME}/bin/${tool}/${x}"
    [ -f "${cmd}" ] && bash -l "${cmd}"
  done
done

# TODO: Check for platform, do platform specific install here.

