#! /usr/bin/env bash

install_miniforge() {
    if [ -e "${CONDA_ROOT}/condabin/conda" ]; then
        echo "conda already installed in ${CONDA_ROOT}"
        return 0
    fi

    local os="UNKNOWN"
    case "$(uname -s)" in
        "Darwin" ) os="MacOSX";;
        "Linux" ) os="Linux";;
    esac

    local arch=$(uname -m)
    local installer_name="Miniforge3-${os}-${arch}.sh"
    local installer="${installer_name}"
    local prefix="https://github.com/conda-forge/miniforge/releases/latest/downloads"

    if [ ! -e "${installer}" ]; then
        # curl -L "${prefix}/${installer_name}" -o "${installer}"
        curl -LO "${prefix}/${installer_name}"
    fi

    if [ ! -e "${installer}" ]; then
        echo "Unable to install miniforge3."
        exit 1
    fi

    bash "${installer}" -b -p "${CONDA_ROOT}"
    rm -f "${installer}"
}

# Create environments from an environment file.
install_venvs() {
    for path in ~/.conda/envs/*.yml; do
        conda env update --file "${path}"
    done
}

main() {
    if [ ! "${PROFILE_SET}" = 1 ]; then
        echo "Please source ${HOME}/.profile."
        exit 1
    fi

    install_miniforge
    install_venvs
}

main "$@"
