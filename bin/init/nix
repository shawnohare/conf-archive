#!/usr/bin/env bash
# Install nix and packages managed by nix.

set -e

echo "Configuring the nix package manager."

# Get nix if necessary.
if [ ! -e "${HOME}/.nix-profile/bin/nix-env" ]; then
  echo "Installing the nix package manager."
  curl "https://nixos.org/nix/install" | sh
fi

# load the nix profile
if [ -e "${USER_NIX_PROFILE}" ]; then
  source "${USER_NIX_PROFILE}"
else
  echo --error "${USER_NIX_PROFILE} not found."
  exit 1
fi

# Install common packages as defined in ~/.nixpkgs/config.nix
echo "Installing nix packages."
if [ ! -e "${NIXPKGS_CONFIG}" ]; then
  # As a stupid hack, we link and then unlink the config, since stow, our
  # symlink farm manager, is installed via the below. This can be bypassed
  # if a simple flat file is used instead, or if stow is manually installed.
  ln -s "${CONF}/nix/etc/nixpkgs/config.nix" "${NIXPKGS_CONFIG}"
  nix-env --install --attr nixpkgs.all
  rm "${NIXPKGS_CONFIG}"
else
  nix-env --install --attr nixpkgs.all
fi

