#!/usr/bin/env bash
# Install nix and packages managed by nix.

set -e

echo "Configuring the nix package manager."

# Get nix if necessary.
if [ ! -e "${HOME}/.nix-profile/bin/nix-env" ]; then
  echo "Installing the nix package manager."
  curl "https://nixos.org/nix/install" | sh
fi

# load the nix profile
if [ -e "${USER_NIX_PROFILE}" ]; then
  source "${USER_NIX_PROFILE}"
else
  # The daemon needs to run for existing shells to use nix.
  source /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
fi

# Install common packages as defined in ~/.nixpkgs/config.nix
echo "Installing nix packages."
echo "For now, skipping installation of packages. Consider using upkg."
# if [ ! -e "${NIXPKGS_CONFIG}" ]; then
#   # As a stupid hack, we link and then unlink the config, since stow, our
#   # symlink farm manager, is installed via the below. This can be bypassed
#   # if a simple flat file is used instead, or if stow is manually installed.
#   mkdir -p "${USER_CONFIG_HOME}/nixpkgs"
#   ln -s "${CONF}/nix/etc/nixpkgs/config.nix" "${NIXPKGS_CONFIG}"
#   nix-env --install --attr nixpkgs.all
#   rm "${NIXPKGS_CONFIG}"
# else
#   nix-env --install --attr nixpkgs.all
# fi

