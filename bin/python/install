#!/usr/bin/env bash
#
# TODO:
# - [ ] Clone and run scripts rather than curl and pipe.
# - [ ] Try and put more of this into the main Makefile.

# Default location for pyenv.  This is overriden by ~/.profile.
PYENV_ROOT="${PYENV_ROOT:-${HOME}/.pyenv}"
export PATH="${PYENV_ROOT}/bin:${PATH}"

# python was sunset in 2020-01-01, and  2.7.18 is the last release.
readonly versions="${PYENV_ROOT}/versions"
readonly ver3="3.8.3"
readonly python3_root="${versions}/${ver3}"
readonly python3_venvs="${python3_root}/envs"
readonly user_root="${python3_venvs}/user"

# Binaries to install in isolated environments:
readonly pkgs=("python-language-server" "black")

# Define python virtualenv requirements. The base requirements in `requirements_common` are installed in every environment.
readonly requirements_common=("pip" "setuptools")
readonly requirements_user=("ipython" "pipx")
readonly requirements_neovim3=("pynvim")


install_pyenv() {
    if [ ! -e "${PYENV_ROOT}/bin/pyenv" ]; then
        echo "Installing pyenv."
        curl -L https://raw.githubusercontent.com/pyenv/pyenv-installer/master/bin/pyenv-installer | bash
    fi
}

# Install a particular version $1 of python via pyenv
install_python() {
    if [ ! -e "${versions}/$1/bin/python" ]; then
        pyenv install "$1"
    fi
}

# Create a python $1 virtualenv named $2.
virtualenv() {
    echo "Installing $1 $2"

    local venv="${versions}/$1/envs/$2"

    if [ ! -e "${venv}/bin/python" ]; then
        echo "Uninstalling previous virtualenv with different version."
        pyenv uninstall --force "$2"
        pyenv virtualenv "$1" "$2"
    fi

    # Update requirements.
    echo "Updating requirements for ${venv}"
    local requirements="requirements_${2}[@]"
    "${venv}/bin/pip" install -U "${requirements_common[@]}" "${!requirements}"

}

# Install global python executables. Each in their own virtualenv.
install_user_pkgs() {

    local pipx="${user_root}/bin/pipx"
    for pkg in "${pkgs[@]}"; do
        "${pipx}" install "${pkg}"
    done
}


main() {
    install_pyenv
    install_python "${ver3}"
    virtualenv "${ver3}" "user"
    virtualenv "${ver3}" "neovim3"
    pyenv global "user" "system"
}

main "$@"
