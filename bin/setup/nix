#!/usr/bin/env bash
# Install nix and packages managed by nix.

set -e

echo "Configuring the nix package manager."

# Get nix if necessary.
if [ ! -e "${HOME}/.nix-profile/bin/nix-env" ]; then
  echo "Installing the nix package manager."
  curl "https://nixos.org/nix/install" | sh
fi

# load the nix profile
f="${HOME}/.nix-profile/etc/profile.d/nix.sh"
if [ -e "${f}" ]; then
  source "${f}"
else
  echo --error "${f} not found."
  exit 1
fi

# Install common packages as defined in ~/.nixpkgs/config.nix
# As a stupid hack, we link and then unlink the config, since stow, our
# symlink farm manager, is installed via the below. This can be bypassed
# if a simple flat file is used instead, perhaps.
ln -s "${CONF}/nix/.nixpkgs/config.nix" "${HOME}/.nixpkgs/config.nix"
nix-env --install --attr nixpkgs.all
rm "${HOME}/.nixpkgs/config.nix"
