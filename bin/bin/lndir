#!/usr/bin/env bash

display_help() {
  cat << 'EOF'


Usage: lndir [-fr] src tar

Description:

Copy the dir structure of the input and symlink its files to the
specified the target directory. 

In principle this command is a less robust version of the GNU stow command that only
links files, and not entire directories.  This is useful when linking
configuration files, as it avoids runtime files from populating the
dotfiles directory.

Options:

--force|-f   : Backup existing files and remove any existing symlinks before linking files.
--help|-h    : Display this help message 
--remove|-r  : Remove symlinks in the target that match files in the source.
--verbose|-v : Verbose messaging.

Examples: 

1.  Suppose ~/dotfiles/bin contains a number of personal binaries that
    should be linked into ~/bin. This can be accomplished via:

      lndir ~/dotfiles/bin ~/dotfiles

EOF
}

# Backup the input file $1
backup_file() {
  if [ -f "${1}" ] && [ ! -L "${1}" ]; then
    mv "${1}" "${1}.$(date "+%Y-%m-%dT%H:%M:%S").backup"
  fi
}

# Remove a passed in symbolic link.
remove_link() {
  [ -L "$1" ] && rm "$1"
}

backup_or_remove() {
  backup_file "${1}"
  remove_link "${1}"
}


main() {
  local force=false
  local remove=false
  local verbose=false

  # parse opts
  while true; do
    case $1 in
      --force | -f)
        force=true
        shift
        ;;
      --remove| -r)
        remove=true
        shift
        ;;
      --verbose | -v)
        verbose=true
        shift
        ;;
      --help | -h)
        display_help
        exit 0
        ;;
      *)
        break
        ;;
    esac
  done

  if [ -z "${1}" ] || [ -z "${2}" ]; then
    >&2 echo "Error: No source or target dir passed."
    return 1
  fi

  local src="${1}"
  local tar="${2}"

  # check to make sure the source dir exists.
  if [ ! -d "${src}" ]; then
    >&2 echo "Error: Source dir ${src} does not exist.  Exiting."
    exit 1
  fi

  $verbose && echo "Linking ${src} to ${tar}"

  cd "${src}" || exit

  # Copy the dir structure to the target and symlink any config files.
  # in bash > v4 you can recurse using for x in **, but os x ships with bash v3
  while read -r path; do
    local dest="${tar}/${path}"

    # CASE that the path is a dir
    # Make the dir
    if [ -d "${path}" ]; then
      if [ ! -d "${dest}" ]; then
        $verbose && echo "Making dir: ${dest}"
        mkdir -p "${dest}" 
        continue
      fi
    fi

    # CASE that the path points to a file
    # Check if the destination file already exists.
    # If it does not exist, link from the dotfiles config.
    # If it's a link, remove if we are restowing, otherwise do nothing.
    # If it exists and is not a link, ask to back it up and then link.
    if [ -f "${path}" ]; then

      if $remove; then
        $verbose && echo "Removing ${dest} if necessary."
        remove_link "${dest}"
        continue
      fi

      if $force; then
        $verbose && echo "Removing file or link ${dest} if necessary."
        backup_or_remove "${dest}"
      fi

      if [ ! -e "${dest}" ]; then
        local fullpath="${src}/${path}"
        $verbose && echo "Linking ${fullpath} to ${dest}"
        ln -s "${fullpath}" "${dest}"
      else
        $verbose || echo "${dest} already exists. Not linking."
      fi
      continue
    fi
  done < <(find .)
}

main "${@}"
