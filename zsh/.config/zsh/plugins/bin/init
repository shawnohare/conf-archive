#!/usr/bin/env zsh
# Create a static init.zsh file. This should be run any time plugins
# are changed, which should be infrequently.


function add() {
  local name="${1##*/}"  # Part after last slash.
  local dir="${ZPLUGIN_HOME}/repos/$1"
  if [[ ! -e "${dir}" ]]; then
    echo "Plugin $1 does not exist. Downloading."
    local src="https://github.com/$1"
    git clone --recursive "${src}" "${dir}"
  fi

  # Attempt to source either <name>.zsh or <name>.plugin.zsh
  local prefix="${dir}/${name}"
  local plugin="${prefix}.zsh"
  if [[ ! -e "${plugin}" ]]; then;
    plugin="${prefix}.plugin.zsh"
  fi

  echo "source ${plugin}" >> "${init_file}"
}

function main() {
  source "${ZPLUGIN_HOME}/plugins.zsh"
  declare -r init_file="${ZPLUGIN_HOME}/init.zsh"

  rm "${init_file}" > /dev/null
  for plugin in "${plugins[@]}"; do
    echo "Adding ${plugin}" to "${init_file}"
    add "${plugin}"
  done
}

main
